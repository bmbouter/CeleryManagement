

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Policies Overview &mdash; CeleryManagement v0.0 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="CeleryManagement v0.0 documentation" href="../index.html" />
    <link rel="up" title="Policies" href="index.html" />
    <link rel="next" title="Policies API" href="api.html" />
    <link rel="prev" title="Policies" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="api.html" title="Policies API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Policies"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">CeleryManagement v0.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Policies</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="policies-overview">
<span id="id1"></span><h1><a class="toc-backref" href="#id5">Policies Overview</a><a class="headerlink" href="#policies-overview" title="Permalink to this headline">¶</a></h1>
<p>Policies are designed to allow some automatic management of Celery workers.
When a policy is executed, they first check to see if a condition is true.  If
it is, then the body of the policy is executed.  Within the body, various
Worker and Task attributes can be modified.</p>
<p>Policies are designed to be simple and focused.  Python language features that
may conflict with this goal are purposely forbidden within policy code.</p>
<p>See <a class="reference internal" href="api.html#policies-api"><em>Policies API</em></a> for information about the objects and functions
available to executing policies.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Policies run outside of Celery.  You may alter worker and task
settings without worrying how it will affect your currently-running policy.</p>
</div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#policies-overview" id="id5">Policies Overview</a><ul>
<li><a class="reference internal" href="#example" id="id6">Example</a></li>
<li><a class="reference internal" href="#policy-sections" id="id7">Policy Sections</a><ul>
<li><a class="reference internal" href="#schedule" id="id8">Schedule</a></li>
<li><a class="reference internal" href="#condition" id="id9">Condition</a></li>
<li><a class="reference internal" href="#apply" id="id10">Apply</a></li>
</ul>
</li>
<li><a class="reference internal" href="#execution-environment" id="id11">Execution Environment</a><ul>
<li><a class="reference internal" href="#scope" id="id12">Scope</a></li>
<li><a class="reference internal" href="#restrictions" id="id13">Restrictions</a></li>
<li><a class="reference internal" href="#exception-handling" id="id14">Exception handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#policy-manager" id="id15">Policy Manager</a></li>
<li><a class="reference internal" href="#common-issues" id="id16">Common Issues</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="example">
<h2><a class="toc-backref" href="#id6">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>The obligatory Hello World example:</p>
<div class="highlight-python"><pre>policy:
    schedule:
        crontab()
    condition:
        True
    apply:
        print "hello world!"</pre>
</div>
<p>This will simply print &#8220;hello world!&#8221; every minute.  However, it illustrates
the three sections of a policy: the schedule, condition, and apply.  The
schedule determines when a policy is run.  The condition determines if the
apply section is run.  And the apply section is the body of the policy—where
Celery Task and Worker settings may be modified.</p>
<p>The <a class="reference internal" href="#schedule"><em>schedule section</em></a> must be an expression that returns an
object that implements the Celery <tt class="docutils literal"><span class="pre">schedule</span></tt> interface.  Currently, the only
available schedule type is <tt class="docutils literal"><span class="pre">crontab</span></tt>, which is provided by Celery and permits
cron-like scheduling.  With no arguments, it defaults to running every minute.</p>
<p>The <a class="reference internal" href="#condition"><em>condition section</em></a> determines if the apply section should
be executed.  If it evaluates to <tt class="xref docutils literal"><span class="pre">True</span></tt>, the apply is run, otherwise it is
not.  It is optional—when not supplied the apply section is run every time.</p>
<p>The <a class="reference internal" href="#apply"><em>apply section</em></a> is the body of the policy—it is where Worker
and Task settings may be modified.</p>
</div>
<div class="section" id="policy-sections">
<h2><a class="toc-backref" href="#id7">Policy Sections</a><a class="headerlink" href="#policy-sections" title="Permalink to this headline">¶</a></h2>
<p>A Policy is made up of three sections: Schedule, Condition and Apply.</p>
<div class="section" id="schedule">
<span id="id2"></span><h3><a class="toc-backref" href="#id8">Schedule</a><a class="headerlink" href="#schedule" title="Permalink to this headline">¶</a></h3>
<p>The Schedule section determines when and/or how frequently a policy is
executed.  The schedule section is required.</p>
<p>The schedule section must be an expression that results in a schedule object.
The <tt class="docutils literal"><span class="pre">crontab</span></tt> function available to policies returns such an object.  (Other
schedule types may be added at a later time, if there is a demand.)</p>
<p>See <a class="reference internal" href="api.html#policy-schedule"><em>Policy Schedule</em></a> in the API documentation for more
information about how to use <tt class="docutils literal"><span class="pre">crontab</span></tt>.</p>
</div>
<div class="section" id="condition">
<span id="id3"></span><h3><a class="toc-backref" href="#id9">Condition</a><a class="headerlink" href="#condition" title="Permalink to this headline">¶</a></h3>
<p>The condition section is what determines whether the apply section will be run.
The idea being that policies follow a simple if...then structure:
if&nbsp;<tt class="docutils literal"><span class="pre">condition</span></tt>&nbsp;then&nbsp;<tt class="docutils literal"><span class="pre">apply</span></tt>.</p>
<p>Some key points about conditions:</p>
<ul class="simple">
<li>They are optional.  A non-existent condition is equivalent to a
condition that always evaluates to True.</li>
<li>They must be simple.  Statements are not permitted—it must be an
expression.</li>
<li>If there are multiple condition sections, the results are effectively ORed
together.  In other words, if any single condition evaluates to True, the
apply section is run.</li>
<li>Multiple lines in a single condition are ANDed together.  In other words, all
lines in a condition must be true for the condition as a whole to evaluate to
True.  (You can work around this using the usual Python line continuation
techniques: a backslash or wrapping it in parentheses.)</li>
</ul>
</div>
<div class="section" id="apply">
<span id="id4"></span><h3><a class="toc-backref" href="#id10">Apply</a><a class="headerlink" href="#apply" title="Permalink to this headline">¶</a></h3>
<p>The apply section is the body of the policy.  It is where the behavior of
Celery can be modified.  The apply section is required.</p>
<p>Unlike the condition and schedule sections which must be expressions, the apply
section can be composed of statements.  To keep policies focused, only a subset
of Python statements are allowed.</p>
</div>
</div>
<div class="section" id="execution-environment">
<h2><a class="toc-backref" href="#id11">Execution Environment</a><a class="headerlink" href="#execution-environment" title="Permalink to this headline">¶</a></h2>
<p>Policies are run in a limited execution environment.  The main purpose of these
restrictions is to keep policies focused and simple.  Policies have a specific
design aim: to provide some automated monitoring and control of Celery workers.
To provide the full power of the Python language may encourage users to put in
policies code which would be better put elsewhere.</p>
<p>The restrictions also provide some measure of security, but they should not be
solely relied upon for this purpose.</p>
<p>There are both parse-time and run-time mechanisms which enforce this
environment.  At parse-time, the policy source is checked for certain language
constructs which are available in the full Python language, but are not desired
in policies.</p>
<div class="section" id="scope">
<h3><a class="toc-backref" href="#id12">Scope</a><a class="headerlink" href="#scope" title="Permalink to this headline">¶</a></h3>
<p>At run-time, each policy is given a new copy of the execution environment in
which to run.  Changes to the namespace (e.g. creating a new name) exist only
while the execution continues.  Other policies, and indeed the same policy
executed at a later time, will not see the changes.</p>
</div>
<div class="section" id="restrictions">
<h3><a class="toc-backref" href="#id13">Restrictions</a><a class="headerlink" href="#restrictions" title="Permalink to this headline">¶</a></h3>
<p class="rubric">Imports</p>
<p>No imports are allowed in policies.  This includes the import statements
<tt class="docutils literal"><span class="pre">import&nbsp;...</span></tt> and <tt class="docutils literal"><span class="pre">from&nbsp;...&nbsp;import&nbsp;...</span></tt> as well as the built-in
<tt class="docutils literal"><span class="pre">__import__</span></tt> function.</p>
<p>Selected built-in modules are made available, including <tt class="docutils literal"><span class="pre">datetime</span></tt>,
<tt class="docutils literal"><span class="pre">time</span></tt>, <tt class="docutils literal"><span class="pre">calendar</span></tt>, and <tt class="docutils literal"><span class="pre">math</span></tt>.  (Actually, they are wrappers around
those modules to prevent any details of those modules leaking into the
execution environment.)</p>
<p class="rubric">Defining functions and classes</p>
<p>Function and class definitions are not allowed in policies.  This includes
the definitions themselves, as well as their associated keywords
(<tt class="docutils literal"><span class="pre">return</span></tt>, <tt class="docutils literal"><span class="pre">yield</span></tt>, etc).  Functions defined using <tt class="docutils literal"><span class="pre">lambda</span></tt> are also
not permitted.</p>
<p class="rubric">Arbitrary code execution</p>
<p>The normal Python languages provides several ways to execute code from
within a script.  None of these methods are available to policies.  This
includes the <tt class="docutils literal"><span class="pre">exec</span></tt> statement and the builtin functions <tt class="docutils literal"><span class="pre">eval()</span></tt>,
<tt class="docutils literal"><span class="pre">compile()</span></tt>, <tt class="docutils literal"><span class="pre">execfile()</span></tt>, and <tt class="docutils literal"><span class="pre">input()</span></tt>.</p>
<p class="rubric">Files</p>
<p>The built-in function <tt class="docutils literal"><span class="pre">open()</span></tt> is not permitted.</p>
<p class="rubric">Assignment</p>
<p>In the schedule and apply sections of a policy, assignment is not
permitted.  For instance: neither <tt class="docutils literal"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></tt> nor <tt class="docutils literal"><span class="pre">x</span> <span class="pre">+=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></tt> is
permitted.  This is because those sections must be expressions.  In the
apply section, assignment is permitted.</p>
<p>Certain API objects cannot be assigned to, even in the apply section.  This
is primarily to alert the user to a possible error.  The names affected
include (but are not limited to) <tt class="docutils literal"><span class="pre">tasks</span></tt>, <tt class="docutils literal"><span class="pre">workers</span></tt>, and <tt class="docutils literal"><span class="pre">stats</span></tt>.</p>
<p class="rubric">Looping statements</p>
<p>Looping statements are not permitted (<tt class="docutils literal"><span class="pre">for</span></tt> and <tt class="docutils literal"><span class="pre">while</span></tt>), except
within list comprehensions and generator expressions.</p>
<p class="rubric">Names</p>
<p>Names beginning with an underscore are not permitted in policies.  This
keeps some implementation details hidden.</p>
<p>Some object attributes have special meaning in Python which should not be
exposed within policies.  Such names are not permitted.  This includes
<tt class="docutils literal"><span class="pre">__dict__</span></tt>, <tt class="docutils literal"><span class="pre">__class__</span></tt>, <tt class="docutils literal"><span class="pre">__new__</span></tt>, and <tt class="docutils literal"><span class="pre">__init__</span></tt> (and several
more).  (Disallowing <tt class="docutils literal"><span class="pre">__init__</span></tt> prohibits its <em>direct</em> use on objects.
It does not affect constructing objects via the class name.  In other
words, <tt class="docutils literal"><span class="pre">x&nbsp;=&nbsp;MyClass()</span></tt> is permitted.)</p>
<p>Names computed at runtime using strings can circumvent the policy
name-checking mechanism.  Therefore, functions which would facilitate this
are prohibited, including <tt class="docutils literal"><span class="pre">getattr()</span></tt>, <tt class="docutils literal"><span class="pre">setattr()</span></tt>, <tt class="docutils literal"><span class="pre">hasattr()</span></tt> and
<tt class="docutils literal"><span class="pre">delattr()</span></tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Names are found by examining the policy source text.  This means that
<em>any</em> use of the forbidden names are prohibited, even if they actually refer
to some other object.  For instance, because the built-in <tt class="docutils literal"><span class="pre">type()</span></tt> function
is prohibited, policy code such as the following will produce errors:
<tt class="docutils literal"><span class="pre">type&nbsp;=&nbsp;&quot;MyType&quot;</span></tt></p>
</div>
</div>
<div class="section" id="exception-handling">
<h3><a class="toc-backref" href="#id14">Exception handling</a><a class="headerlink" href="#exception-handling" title="Permalink to this headline">¶</a></h3>
<p>The goal of the policy mechanism is to make it as robust in the face of
exceptions as possible.  Care is taken in the implementation to prevent an
exception raised while one policy is executing from affecting other policies as
well as the Policy Manager process.  Where exceptions must be prevented from
propagating further, the Policy Manager will attempt to print out the exception
traceback.</p>
<p>Some details:</p>
<ul class="simple">
<li>Syntax Errors found while compiling a policy are displayed through the web
interface.</li>
<li>Exceptions thrown while a policy is executing are generally handled by the
Policy Manager.  It will write them to the logger, which by default is
stdout.</li>
<li>Exceptions thrown from within a Celery worker (while reading or writing
task or worker settings) are handled within the worker.  A traceback may be
written by the worker and the Policy Manager, so in such cases, it is
probably best to consult both the celeryd and Policy Manager logs.</li>
</ul>
</div>
</div>
<div class="section" id="policy-manager">
<h2><a class="toc-backref" href="#id15">Policy Manager</a><a class="headerlink" href="#policy-manager" title="Permalink to this headline">¶</a></h2>
<p>The Policy Manager is the process that executes the policies.  There are two
ways to run it: directly using <tt class="docutils literal"><span class="pre">cmpolicy</span></tt> or as part of <tt class="docutils literal"><span class="pre">cmrun</span></tt>.  Both of
these must be run as Django commands.</p>
<p class="rubric">cmpolicy</p>
<p>usage: <tt class="docutils literal"><span class="pre">python&nbsp;manage.py&nbsp;cmpolicy&nbsp;[options]</span></tt></p>
<p>options:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-l <var>LEVEL</var></span>, <span class="option">--loglevel=<var>LEVEL</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Logging level.  One of: fatal, critical, error,
warning, info, debug.  Default is warning.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-f <var>FILE</var></span>, <span class="option">--logfile=<var>FILE</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Logging file.  Default is stdout.</td></tr>
</tbody>
</table>
<p class="rubric">cmrun</p>
<p>usage: <tt class="docutils literal"><span class="pre">python&nbsp;manage.py</span> <span class="pre">cmrun</span> <span class="pre">[options]</span></tt></p>
<p>The cmrun command runs both the <tt class="docutils literal"><span class="pre">cmpolicy</span></tt> and <tt class="docutils literal"><span class="pre">cmevents</span></tt> commands as
subprocesses.  However, they share the command line options, so the log output
may be garbled and some portions may be missing. For this reason, it is
recommended that <tt class="docutils literal"><span class="pre">cmpolicy</span></tt> and <tt class="docutils literal"><span class="pre">cmevents</span></tt> be used directly.</p>
</div>
<div class="section" id="common-issues">
<h2><a class="toc-backref" href="#id16">Common Issues</a><a class="headerlink" href="#common-issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The Policy Manager must be running for policies to be executed.</li>
<li>It must have access to the django database where Dispatched Task status is
recorded.</li>
<li>Celery workers must have access to the CeleryManagementLib package.  (Usually
this means installing it on the worker&#8217;s (virtual) machine.)</li>
<li>A policy may take a while to execute.  This is mostly due to the time it
takes a policy to communicate with Celery Workers.  Since policies should be
short and run infrequently, this hopefully will not be a significant issue.
However, if execution time becomes a problem, we may look to improve it.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Policies Overview</a><ul>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#policy-sections">Policy Sections</a><ul>
<li><a class="reference internal" href="#schedule">Schedule</a></li>
<li><a class="reference internal" href="#condition">Condition</a></li>
<li><a class="reference internal" href="#apply">Apply</a></li>
</ul>
</li>
<li><a class="reference internal" href="#execution-environment">Execution Environment</a><ul>
<li><a class="reference internal" href="#scope">Scope</a></li>
<li><a class="reference internal" href="#restrictions">Restrictions</a></li>
<li><a class="reference internal" href="#exception-handling">Exception handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#policy-manager">Policy Manager</a></li>
<li><a class="reference internal" href="#common-issues">Common Issues</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Policies</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api.html"
                        title="next chapter">Policies API</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/policy/overview.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="api.html" title="Policies API"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Policies"
             >previous</a> |</li>
        <li><a href="../index.html">CeleryManagement v0.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Policies</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, ITng Services.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>